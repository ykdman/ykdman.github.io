---
title: 2024.05.27 í”„ë¡œê·¸ë˜ë¨¸ìŠ¤-ë¶ë¼ì˜¤ (bookkio) ì¢‹ì•„ìš” ê¸°ëŠ¥ êµ¬í˜„
date: 2024-05-27 13:00:00 +09:00
categories: [TIL, í”„ë¡œê·¸ë˜ë¨¸ìŠ¤]
tags:
  [
    TIL,
    API,
    ERD,
    DataBase,
    RESTful,
    MySql
  ]
image : ../assets/img/common/pgms.jpg
---
# Bookkio í”„ë¡œì íŠ¸ 4ì¼ì°¨

## ğŸ‘ì¢‹ì•„ìš” API êµ¬í•˜ê¸°

![likes-table](../assets/img/post/2024/05/27/likes-table.png)

likes í…Œì´ë¸”ì„ ìœ„ì™€ ê°™ì´ ìƒì„±í•˜ì—¬, user_idëŠ” users.idë¥¼ FKë¡œ book_idëŠ” books.idë¥¼ FK ì„¤ì •í•˜ì—¬ì¤€ë‹¤.

likes í…Œì´ë¸”ì˜ ê° ì»¬ëŸ¼ì€ ê°ê° users, books ì˜ idì— ëŒ€í•´ N ê°œë¥¼ ë°›ì•„ë“¤ì´ë¯€ë¡œ

N : 1 ì˜ê´€ê³„ê°€ ì„±ë¦½í•œë‹¤.

![bookkio-ERD](../assets/img/post/2024/05/27/BOOKKIO-ERD.png)

### ì¢‹ì•„ìš” API ì„¤ê³„

1. ì¢‹ì•„ìš” ì¶”ê°€ API
- Method : `POST`
- URI : `/likes/{book_id}`
- HTTP Status Code : 200
- Request Body
    - Token > Header â€œAuthorizationâ€
    - í˜„ì¬ Token ì„ ì €ì¥í•´ë†“ì„ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, Tokenì„ ì €ì¥í–ˆë‹¤ëŠ” ì „ì œí•˜ì— ì•„ë˜ Body ì‚¬ìš©
        
        ```json
        {
        	"email" : "ì‚¬ìš©ì EMAIL",
        	"id" : "ì‚¬ìš©ì ID"
        }
        ```
        
- Response Body

1. ì¢‹ì•„ìš” ì·¨ì†Œ API
- Method : `DELETE`
- URI : `/likes/{book_id}`
- HTTP Status Code : 200
- Request Body
- Response Body

### ì¢‹ì•„ìš” API ì½”ë“œ ì‘ì„±

ìƒˆë¡­ê²Œ ë§Œë“œëŠ” ê¸°ëŠ¥ì´ë©°, URIë˜í•œ ê¸°ì¡´ì— ì‚¬ìš©í•˜ë˜ ê²ƒë“¤ê³¼ ë‹¤ë¥´ë¯€ë¡œ, ìƒˆë¡œìš´ Routerì™€ Controllerë¥¼ ë§Œë“ ë‹¤.

- likes.route.js
    
    ```js
    const express = require("express");
    
    const router = express.Router();
    
    const { addLike, deleteLike } = require("../controller/likes.controller.js");
    
    router.post("/:bookId", addLike);
    router.delete("/:bookId", deleteLike);
    
    module.exports = router;
    
    ```
    
- likes.controller.js
    
    ```js
    /**
     * ì¢‹ì•„ìš” ì¶”ê°€ API
     * @param {import("express").Request} req
     * @param {import("express").Response} res
     */
    const addLike = (req, res) => {
      return res.status(200).json({ message: "ì¢‹ì•„ìš” ì¶”ê°€ API" });
    };
    
    /**
     * ì¢‹ì•„ìš© ì œê±° API
     * @param {import("express").Request} req
     * @param {import("express").Response} res
     * @returns
     */
    const deleteLike = (req, res) => {
      return res.status(200).json({ message: "ì¢‹ì•„ìš” ì œê±° API" });
    };
    
    module.exports = {
      addLike,
      deleteLike,
    };
    
    ```
    
- app.js
    
    ```js
    const createError = require("http-errors");
    const express = require("express");
    const path = require("path");
    const cookieParser = require("cookie-parser");
    const logger = require("morgan");
    
    const usersRouter = require("./routes/users.router.js");
    const booksRouter = require("./routes/books.route.js");
    const cartsRouter = require("./routes/cart.route.js");
    const ordersRouter = require("./routes/orders.route.js");
    const likesRouter = require("./routes/likes.router.js");
    
    const app = express();
    
    // view engine setup
    app.set("views", path.join(__dirname, "views"));
    app.set("view engine", "ejs");
    
    app.use(logger("dev"));
    app.use(express.json());
    app.use(express.urlencoded({ extended: false }));
    app.use(cookieParser());
    app.use(express.static(path.join(__dirname, "public")));
    
    // Routing
    app.use("/users", usersRouter);
    app.use("/books", booksRouter);
    app.use("/cart", cartsRouter);
    app.use("/orders", ordersRouter);
    app.use("/likes", likesRouter);
    ```
    

ìœ„ì˜ controllerì½”ë“œì—ì„œ ì¢‹ì•„ìš” ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ë„ë¡ ì˜ˆì™¸ì²˜ë¦¬ ì—†ì´ í•œë²ˆ í•¨ìˆ˜ì˜ ì½”ë“œë¥¼ ì‘ì„±í•´ë³´ì.

- ê¸°ëŠ¥ì´ ë™ì‘í•˜ëŠ” likes.controller.js
    
    ```js
    const dbConnection = require("../model/mysql.js");
    const { StatusCodes } = require("http-status-codes");
    
    /**
     * ì¢‹ì•„ìš” ì¶”ê°€ API
     * @param {import("express").Request} req
     * @param {import("express").Response} res
     */
    const addLike = (req, res) => {
      const { userId } = req.body;
      const { bookId } = req.params;
    
      let sqlQuery = `
      INSERT INTO likes (user_id, book_id)
      VALUES (?, ?);
      `;
    
      dbConnection.query(sqlQuery, [+userId, +bookId], (err, result) => {
        if (err) {
          return res
            .status(StatusCodes.BAD_REQUEST)
            .json({ message: "ì˜ëª»ëœ ìš”ì²­ì •ë³´ ì…ë‹ˆë‹¤." });
        }
    
        return res.status(StatusCodes.OK).json(result.affectedRows);
      });
    };
    
    /**
     * ì¢‹ì•„ìš© ì œê±° API
     * @param {import("express").Request} req
     * @param {import("express").Response} res
     * @returns
     */
    const deleteLike = (req, res) => {
      const { userId } = req.body;
      const { bookId } = req.params;
    
      let sqlQuery = `
        DELETE FROM likes
        WHERE user_id=? AND book_id=?;
      `;
      dbConnection.query(sqlQuery, [+userId, +bookId], (err, result) => {
        if (err) {
          return res
            .status(StatusCodes.BAD_REQUEST)
            .json({ message: "ì˜¬ë°”ë¥´ì§€ ì•Šì€ ìš”ì²­ ì…ë‹ˆë‹¤." });
        }
    
        return res.status(StatusCodes.OK).json(result.affectedRows);
      });
    };
    
    module.exports = {
      addLike,
      deleteLike,
    };
    
    ```
    

### ì¢‹ì•„ìš” ìˆ˜ ë°˜í™˜ì„ ìœ„í•œ ì„œë¸Œ ì¿¼ë¦¬ ì‘ì„±

```sql
SELECT *, 
(SELECT COUNT(*) from likes WHERE book_id = books.id) AS likes 
FROM books;
```

- like ì»¬ëŸ¼ì„ ìƒˆë¡œ ë§Œë“¤ì–´, í•´ë‹¹ ì»¬ëŸ¼ì— ì„œë¸Œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•˜ì—¬ ìˆ˜í–‰í•œë‹¤.
- ì´ë•Œ ê° books.id ì— ëŒ€í•œ COUNT ê°’ì„ ê³„ìˆ˜í•˜ê¸° ìœ„í•´, likesí…Œì´ë¸”ì˜ book_id ëŠ” book.idë¥¼ ì°¸ì¡°í•˜ë„ë¡ ìœ„ì™€ ê°™ì´ ì‘ì„±í•˜ë©´, í”„ë¡œê·¸ë˜ë° ì–¸ì–´ì˜ ë°˜ë³µë¬¸ ì²˜ëŸ¼, books ê° í–‰ì˜ idë¥¼ ì°¸ì¡°í•˜ì—¬ ì„œë¸Œì¿¼ë¦¬ë¬¸ì„ ì‹¤í–‰ í•˜ê²Œ ëœë‹¤.

![ì¢‹ì•„ìš”-ì„œë¸Œì¿¼ë¦¬](../assets/img/post/2024/05/27/ì¢‹ì•„ìš”%20ì„œë¸Œì¿¼ë¦¬.png)

í•´ë‹¹ ì¿¼ë¦¬ë¬¸ì¤‘, ì„œë¸Œ ì¿¼ë¦¬ì— í•´ë‹¹í•˜ëŠ” êµ¬ë¬¸ì„ ë„ì„œ ì¡°íšŒ API ì»¨íŠ¸ë¡¤ëŸ¬ì— ì¶”ê°€ì ìœ¼ë¡œ ì ìš© ì‹œí‚¨ë‹¤.

- books.controller.js
    
    ```js
    const dbConnection = require("../model/mysql.js");
    const { StatusCodes } = require("http-status-codes");
    
    /**
     * ì „ì²´ ë„ì„œ ì¡°íšŒ Or ì¹´í…Œê³ ë¦¬ë³„ ë„ì„œ ì¡°íšŒ
     * @param {import("express").Request} req
     * @param {import("express").Response} res
     * @param {import("express").NextFunction} next
     */
    const searchBooks = (req, res, next) => {
      let { category_id, limit, currentpage } = req.query;
    
      if (!limit || !currentpage) {
        limit = !limit ? 5 : limit;
        currentpage = !currentpage ? 1 : currentpage;
      }
    
      const offset = +limit * (+currentpage - 1);
    
      //ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰
      if (category_id) {
        let sqlQuery = `
        SELECT *, (SELECT COUNT(*) from likes WHERE book_id = books.id) AS likes FROM books LEFT 
        JOIN category ON books.category_id = category.id
        WHERE books.category_id = ?
        LIMIT ? OFFSET ?;
        `;
    
        dbConnection.query(
          sqlQuery,
          [+category_id, +limit, offset],
          (err, results) => {
            if (err) {
              console.log(err);
              return res.status(StatusCodes.BAD_REQUEST);
            }
    
            if (results.length > 0) {
              return res.status(StatusCodes.OK).json(results);
            } else {
              return res.status(StatusCodes.NOT_FOUND).end();
            }
          }
        );
      } else {
        // ì „ì²´ ë„ì„œ ì¡°íšŒ
        let sqlQuery = `
        SELECT *, (SELECT COUNT(*) from likes WHERE book_id = books.id) AS likes FROM books
        LIMIT ? OFFSET ?
        `;
        dbConnection.query(sqlQuery, [+limit, offset], (err, results) => {
          if (err) {
            console.log(err);
            return res.status(StatusCodes.BAD_REQUEST).end();
          }
    
          if (results[0]) {
            const books = results.map((book) => {
              const resultBook = {
                id: book.id,
                title: book.title,
                summary: book.summary,
                author: book.author,
                price: book.price,
                pub_date: book.pub_date,
                likes: book.likes,
              };
              return resultBook;
            });
            return res.status(StatusCodes.OK).json(books);
          }
        });
      }
    };
    
    /**
     * ê°œë³„ ë„ì„œ ì¡°íšŒ ë¡œì§
     * @param {import("express").Request} req
     * @param {import("express").Response} res
     * @param {import("express").NextFunction} next
     */
    const searchOneBook = (req, res, next) => {
      const { bookId } = req.params;
      let sqlQuery = `
        SELECT *, (SELECT COUNT(*) from likes WHERE book_id = books.id) AS likes FROM books
        WHERE id=?;
      `;
      dbConnection.query(sqlQuery, [+bookId], (err, results) => {
        if (err) {
          console.log(err);
          return res.status(StatusCodes.BAD_REQUEST).end();
        }
    
        const book = results[0];
        if (book) {
          return res.status(StatusCodes.OK).json(book);
        } else {
          return res.status(StatusCodes.NOT_FOUND).end();
        }
      });
    };
    
    /**
     * 1ë‹¬ ì´ë‚´ ì¶œê°„ëœ ì‹ ê°„ ë„ì„œ ì¡°íšŒ
     * @param {import("express").Request} req
     * @param {import("express").Response} res
     * @param {import("express").NextFunction} next
     */
    const getNewBooks = (req, res, next) => {
      const { limit, currentpage } = req.query;
      const offset = +limit * (+currentpage - 1);
    
      let sqlQuery = `
      SELECT *, (SELECT COUNT(*) from likes WHERE book_id = books.id) AS likes FROM bookkio.books
      WHERE pub_date BETWEEN DATE_SUB(NOW(), INTERVAL 1 MONTH) AND NOW()
      LIMIT ? OFFSET ?
      `;
    
      dbConnection.query(sqlQuery, [+limit, offset], (err, results) => {
        if (err) {
          console.log(err);
          return res.status(StatusCodes.BAD_REQUEST).end();
        }
    
        if (results.length > 0) {
          return res.status(StatusCodes.OK).json(results);
        } else {
          return res.status(StatusCodes.NOT_FOUND).end();
        }
      });
    };
    
    module.exports = {
      searchBooks,
      searchOneBook,
      getNewBooks,
    };
    
    ```
    

## ì‚¬ìš©ìê°€ ì¢‹ì•„ìš”í•œ ì±…ì¸ì§€ í™•ì¸í•˜ëŠ” ì¿¼ë¦¬

```sql
SELECT *,
(SELECT COUNT(*) FROM likes WHERE book_id =books.id) AS likes,
(SELECT EXISTS (SELECT * FROM likes WHERE user_id=1 AND book_id=1)) AS liked
 FROM books;
```

ìœ„ì˜ ì¿¼ë¦¬ë¥¼ í†µí•˜ì—¬ 2ë²ˆì§¸ ì„œë¸Œì¿¼ë¦¬ëŠ” ê¸°ì¡´ê³¼ ë˜‘ê°™ì´ ê° ë„ì„œê°€ ì–¼ë§Œí¼ì˜ ì¢‹ì•„ìš”ë¥¼ ë°›ì•˜ëŠ”ì§€ í™•ì¸í•˜ê³ ,

3ë²ˆì§¸ ì¤„ì˜ ì„œë¸Œì¿¼ë¦¬ëŠ” userì˜ idì™€ bookì˜ idë¥¼ í†µí•˜ì—¬, ì‚¬ìš©ìê°€ í•´ë‹¹ ë„ì„œì— ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ëŠ”ì§€ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

- ìœ„ì˜ ì½”ë“œì—ì„œ EXISTS êµ¬ë¬¸ì€ ì¡°íšŒëœ ê°’ì˜ ê°¯ìˆ˜ë¥¼ ë°˜í™˜ í•˜ê²Œ ë˜ëŠ”ë° ë¬´ì¡°ê±´ 1ì•„ë‹ˆë©´ 0ì´ ë°œìƒ
- WHERE ì ˆë¡œ ì´ì–´ì„œ ì‚¬ìš©í•˜ëŠ” EXISTêµ¬ë¬¸ì˜ ê²½ìš° TRUE, FALSE ë¥¼ ë°˜í™˜í•œë‹¤.

ì´ëŸ° ì¿¼ë¦¬ë¥¼ ì‘ì„±í–ˆë‹¤ë©´, í•œ ê°€ì§€ ì ìš©í•  ì ì´ ìƒê¸´ë‹¤.

ê°œë³„ ë„ì„œë¥¼ ì¡°íšŒí•  ë•Œ, ì¢‹ì•„ìš” ìˆ˜ì™€, ìœ ì €ì˜ ì¢‹ì•„ìš” ì—¬ë¶€, ì¹´í…Œê³ ë¦¬ ëª… ê¹Œì§€ ì¶œë ¥í•´ì¤„ìˆ˜ëŠ” ì—†ì„ê¹Œ?

ìœ„ì— í•´ë‹¹í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ì‘ì„±í•´ì•˜ë‹¤.

```sql
SELECT *,
(SELECT COUNT(*) FROM likes WHERE book_id = books.id) AS likes,
(SELECT EXISTS (SELECT * FROM likes WHERE user_id=1 AND book_id=1)) AS liked
FROM books
LEFT JOIN category
ON books.category_id = category.id
WHERE books.id= 1;
```

í•´ë‹¹ ì¿¼ë¦¬ë¥¼ ì ìš©í•˜ì—¬ `ê°œë³„ ë„ì„œ ì¡°íšŒ` ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì˜€ë‹¤.

```js
/**
 * ê°œë³„ ë„ì„œ ì¡°íšŒ ë¡œì§
 * @param {import("express").Request} req
 * @param {import("express").Response} res
 * @param {import("express").NextFunction} next
 */
const searchOneBook = (req, res, next) => {
  const { bookId } = req.params;
  const { userId } = req.body;
  let sqlQuery = `
  SELECT *,
  (SELECT COUNT(*) FROM likes WHERE book_id = books.id) AS likes,
  (SELECT EXISTS (SELECT * FROM likes WHERE user_id=? AND book_id=?)) AS liked
  FROM books
  LEFT JOIN category
  ON books.category_id = category.category_id
  WHERE books.id= ?;
  `;
  dbConnection.query(sqlQuery, [+userId, +bookId, +bookId], (err, results) => {
    if (err) {
      console.log(err);
      return res.status(StatusCodes.BAD_REQUEST).end();
    }

    const book = results[0];
    if (book) {
      return res.status(StatusCodes.OK).json(book);
    } else {
      return res.status(StatusCodes.NOT_FOUND).end();
    }
  });
};
```

![postman ê²°ê³¼](../assets/img/post/2024/05/27/postman-ê°œë³„ë„ì„œì¡°íšŒ-ê²°ê³¼.png)