---
title: 2024.05.28 í”„ë¡œê·¸ë˜ë¨¸ìŠ¤-ë¶ë¼ì˜¤ (bookkio) ì¥ë°”êµ¬ë‹ˆ API êµ¬í˜„
date: 2024-05-28 13:00:00 +09:00
categories: [TIL, í”„ë¡œê·¸ë˜ë¨¸ìŠ¤]
tags:
  [
    TIL,
    API,
    ERD,
    DataTable,
    RESTful,
    API,
    BE
  ]
image : ../assets/img/common/pgms.jpg
---


# Bookkio í”„ë¡œì íŠ¸ 5ì¼ì°¨

- ì¥ë°”êµ¬ë‹ˆ ê¸°ëŠ¥ êµ¬í˜„

## cartItems Table ë§Œë“¤ê¸°

ìœ ì €ê°€ ì¥ë°”êµ¬ë‹ˆì— ì•„ì´í…œì„ ì¶”ê°€í•˜ë©´, í•´ë‹¹ ìœ ì €ì˜ DBìƒ IDì™€ í•´ë‹¹ ë„ì„œì˜ ID, ì¶”ê°€ëœ ê°¯ìˆ˜ (Count)

í•´ë‹¹ ì¥ë°”êµ¬ë‹ˆ í•­ëª©ì˜ ID ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” Tableì„ ìƒì„±í•œë‹¤.

- cartItems Table Column ì„¤ì •
    
    ![cartitem-table](../assets/img/post/2024/05/28/cartitem_column.png)
    
- FK ì œì•½ ì¡°ê±´ ì„¤ì •
    
    ![fk_userIDì œì•½ì¡°ê±´](../assets/img/post/2024/05/28/fk_cartitems_users_id.png)
    
    ![fk_bookIDì œì•½ì¡°ê±´](../assets/img/post/2024/05/28/fk_cartitems_books_id.png)
    
    FK ì œì•½ ì¡°ê±´ ì„¤ì • ì‹œ, ë‹¤ë¥¸ í…Œì´ë¸”ì—ì„œ ì„¤ì •í•œ ì œì•½ì¡°ê±´ì˜ ì´ë¦„ê³¼ ì¤‘ë³µë˜ëŠ” ì´ë¦„ìœ¼ë¡œ ì„¤ì •í•˜ë©´,
    
    **`errno: 121 "Duplicate key on write or updateâ€`** ê°€ ë°œìƒí•˜ë¯€ë¡œ, 
    
    `fk_í…Œì´ë¸”ëª…_ì°¸ì¡°í…Œì´ë¸”ëª…_ì»¬ëŸ¼`ì˜ ë°©ì‹ìœ¼ë¡œ FK ì´ë¦„ì„ ì§€ì •í•˜ì˜€ë‹¤.
    

- í˜„ì¬ê¹Œì§€ì˜ ERD
    
    ![bookkio-ERD](../assets/img/post/2024/05/28/bookkio-ERD.png)
    

## ì¥ë°”êµ¬ë‹ˆ ê¸°ëŠ¥ API êµ¬í˜„

ì¥ë°”êµ¬ë‹ˆ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê¸° ì „ì—, ë„ì„œ ê´€ë ¨ ë„ë©”ì¸ì¤‘ ê°€ì¥ ìœ ëª…í•œ êµë³´ë¬¸ê³ ì™€ YES24ì˜ APIì— ëŒ€í•´ í¬ë¡¬ ê°œë°œìë„êµ¬ë¡œ ë‚˜ë¦„ ë¶„ì„ì„ í•´ë³´ì•˜ë‹¤.

### êµë³´ë¬¸ê³ 

![êµë³´ë¬¸ê³  ë¡œì»¬ìŠ¤í† ë¦¬ì§€](../assets/img/post/2024/05/28/êµë³´ë¬¸ê³ _ì¥ë°”êµ¬ë‹ˆ_LocStorage.png)

ìš°ì„  êµë³´ë¬¸ê³ ëŠ” ë¡œê·¸ì¸ í›„ì—, ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í•˜ë©´, ì—°ê²°ëœ ENDPOINTë¡œ Request ë¿ë§Œì•„ë‹ˆë¼

í´ë¼ì´ì–¸íŠ¸ LocalStorageì—ë„ í•´ë‹¹ ìƒí’ˆì„ ë“±ë¡í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆì—ˆë‹¤.

![êµë³´ë¬¸ê³ _ë„¤íŠ¸ì›Œí¬](../assets/img/post/2024/05/28/êµë³´ë¬¸ê³ _ì¥ë°”êµ¬ë‹ˆ_Network.png)

ë˜í•œ ë³„ë„ì˜ params ì—†ì´ ì—°ê²°ëœ ENDPOINTë¡œ ìš”ì²­ì„ ì „ì†¡í•˜ë©´ì„œ, í´ë¼ì´ì–¸íŠ¸ cookieì˜ ê³„ì •ì •ë³´ì— ì ‘ì´‰í•˜ì—¬ í•´ë‹¹ ê³„ì •ì˜ ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì„ ì¶”ê°€í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.

### YES 24

![YES24_ë„¤íŠ¸ì›Œí¬](../assets/img/post/2024/05/28/YES24_Network.png)

YES24ëŠ” ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì„ ì¶”ê°€í•˜ëŠ” ê²½ìš° êµë³´ë¬¸ê³ ì™€ ë‹¤ë¥´ê²Œ ì„œë¸Œ URLì— ì—¬ëŸ¬ ì •ë³´ë¥¼ ì…ë ¥í•˜ì—¬ í•´ë‹¹ ìƒí’ˆì— ëŒ€í•œ ì •ë³´ë¥¼ ê°€ì§€ê³ , ì¶”ê°€ì •ë³´ (ì‚¬ìš©ì)ëŠ” Cookieì—ì„œ ê°€ì ¸ì˜¤ëŠ”ê²ƒìœ¼ë¡œ ìƒê° ëœë‹¤.

YES24ëŠ” í´ë¼ì´ì–¸íŠ¸ ì¸¡ì— ì¥ë°”êµ¬ë‹ˆ ìª½ ì •ë³´ë¥¼ ì €ì¥í•˜ì§€ëŠ” ì•ŠëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.

êµë³´ë¬¸ê³ ëŠ” ìƒê° ë³´ë‹¤ í´ë¼ì´ì–¸íŠ¸ì¸¡ì— ë§ì€ê²ƒì„ ì €ì¥í•˜ì§€ ì•Šê³ , YES24ëŠ” ìƒê°ë³´ë‹¤ ë” ë§ì€ ì •ë³´ë¥¼ í´ë¼ë¦¬ì–¸íŠ¸ ë¸Œë¼ìš°ì € (localStorage, Cookiesë“±) ì— ì €ì¥í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆì—ˆë‹¤.

### ğŸ’¡ê·¸ëŸ¬ë©´ ë‚´ê°€ êµ¬í˜„í•  ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ APIëŠ”?

ë‚´ê°€ êµ¬í˜„í•  ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆ ë‹´ê¸° API ëŠ” í˜„ì¬ JWTê¸°ëŠ¥ì´ ì—†ê¸°ì—, ì•„ë¬´ë˜ë„ Bodyì— userì™€ productì— ëŒ€í•œ ì •ë³´ë¥¼ ë‹´ì•„ Requestë¥¼ í•´ì•¼ í•  ê²ƒ ê°™ë‹¤.

JWTê¸°ëŠ¥ì„ êµ¬í˜„í•´ë†“ê³  í´ë¼ì´ì–¸íŠ¸ FE ê°€ ì¡´ì¬ í•œë‹¤ë©´, Cookieë‚˜ localstorageì— ìˆëŠ” ì‚¬ìš©ì ì¸ì¦ ì •ë³´ë¥¼ í† ëŒ€ë¡œ, ì•”í˜¸í™”ëœ ê³„ì •ì •ë³´ë¥¼ ë³µí˜¸í™” í•˜ì—¬ í•´ë‹¹ ê³„ì •ì˜ id ë˜ëŠ” ë‹¤ë¥¸ PK ì •ë³´ë¡œ cartitems DBì— ë“±ë¡ í•˜ëŠ”ê²Œ ì–´ë–¨ê¹Œ ë¼ëŠ” ìƒê°ì„ í•´ë³´ì•˜ë‹¤.

### ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° API êµ¬í˜„

```js
const dbConnection = require("../model/mysql.js");
const { StatusCodes } = require("http-status-codes");
/**
 * ì¥ë°”êµ¬ë‹ˆì— ì•„ì´í…œ ë‹´ê¸° ë¡œì§
 * @param {import("express").Request} req
 * @param {import("express").Response} res
 * @param {import("express").NextFunction} next
 */
const addItemToCart = (req, res, next) => {
  const { bookId, userId } = req.body;

  let sqlQuery = `
    SELECT * FROM cartitems
    WHERE user_id=? AND book_id=?;
  `;
  let queryArg = [+userId, +bookId];

  dbConnection.query(sqlQuery, queryArg, (err, results) => {
    if (err) {
      return res.status(StatusCodes.BAD_REQUEST).end();
    }

    if (results.length > 0) {
      // ì¥ë°”êµ¬ë‹ˆì— ì´ë¯¸ ìˆëŠ” ê²½ìš° ê°œìˆ˜ ì¦ê°€
      const existItem = { ...results[0], qty: results[0].qty + 1 };
      sqlQuery = `
        UPDATE cartitems
        SET qty=?
        WHERE id = ? 
      `;
      queryArg = [existItem.qty, existItem.id];

      dbConnection.query(sqlQuery, queryArg, (err, results) => {
        if (err) {
          return res.status(StatusCodes.INTERNAL_SERVER_ERROR).end();
        }

        return res.status(StatusCodes.OK).json(existItem);
      });
    } else {
      // ì¥ë°”êµ¬ë‹ˆì— ì—†ëŠ” ê²½ìš° => ìƒˆë¡œ ì¶”ê°€í•˜ëŠ” ìƒí’ˆ
      sqlQuery = `
        INSERT INTO cartitems (book_id, user_id, qty)
        VALUES (?,?,?);
      `;
      queryArg = [+bookId, +userId, 1];

      dbConnection.query(sqlQuery, queryArg, (err, results) => {
        if (err) {
          return res.status(StatusCodes.INTERNAL_SERVER_ERROR).end();
        }

        return res.status(StatusCodes.OK).json({ result: results });
      });
    }
  });
};
```

ìš°ì„  ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆ ë‹´ê¸°ì—ì„œëŠ” ë¶„ê¸°í•´ì•¼í•  ì¡°ê±´ì´ ìƒí’ˆì´ ì´ë¯¸ ì¹´íŠ¸ì— ë‹´ê²¨ìˆì„ ê²½ìš°ì™€ ìƒˆë¡œ ì¶”ê°€í•˜ëŠ” ê²½ìš°ë¡œ ë‚˜ë‰˜ê²Œ ë˜ì–´, í•´ë‹¹ ë¶„ê¸°ì—ëŒ€í•´ ìˆ˜í–‰í•˜ë„ë¡ ì½”ë“œë¥¼ ì‘ì„± í•˜ì˜€ë‹¤.

ìƒí’ˆì´ ì´ë¯¸ ìˆëŠ” ê²½ìš°, queryë¡œ ê°€ì ¸ì˜¨ ì •ë³´ì—ì„œ qty ê°’ë§Œ +1ì„ í•˜ì—¬ SQL  UPDATE êµ¬ë¬¸ìœ¼ë¡œ ìˆ˜ëŸ‰ì„ ì¦ê°€ ì‹œí‚¨ë‹¤.

ìƒí’ˆì´ ì—†ëŠ” ê²½ìš°, í•´ë‹¹ ë„ì„œ idì™€ ì‚¬ìš©ì idë¥¼ í†µí•´ ìƒˆë¡œìš´ rowë¥¼ INSERT í•˜ë©°, qtyê°’ì€ 1ë¡œ ê³ ì •í•˜ì—¬ ë°ì´í„°ë¥¼ ìƒì„±í•œë‹¤.

- ìƒˆë¡œìš´ ë„ì„œë¥¼ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í•œ ê²°ê³¼ (postman)
    
    ![ìƒˆìƒí’ˆ ì¶”ê°€ ê²°ê³¼](../assets/img/post/2024/05/28/ìƒˆìƒí’ˆ%20ì¥ë°”êµ¬ë‹ˆì—%20ì¶”ê°€%20ê²°ê³¼.png)
    
- ê¸°ì¡´ì— ìˆë˜ ë„ì„œë¥¼ ì¥ë°”êµ¬ë‹ˆì— ì¶”ê°€í•œ ê²°ê³¼ (postman)
    
    ![ê¸°ì¡´ìƒí’ˆ ì¶”ê°€ ê²°ê³¼](../assets/img/post/2024/05/28/ê¸°ì¡´ìƒí’ˆ%20ì¥ë°”êµ¬ë‹ˆ%20ì¶”ê°€.png)
    

### ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ ì¡°íšŒ API êµ¬í˜„

ì‚¬ìš©ì í•œ ëª…ì— ëŒ€í•œ ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ë§Œ ì¡°íšŒí•˜ë©´ ì¶©ë¶„í•œ ê¸°ëŠ¥ì´ë¯€ë¡œ

í•´ë‹¹ ì¿¼ë¦¬ë¬¸ì„ ë¨¼ì € ì‘ì„±í•´ ë³´ì•˜ë‹¤.

```sql
SELECT cartitems.id AS cart_id, 
books.price AS book_price, 
cartitems.qty AS cart_qty, 
cartItems.user_id AS user_id, 
cartItems.book_id AS book_id   
FROM cartitems LEFT 
JOIN books ON books.id = cartitems.book_id
WHERE cartitems.user_id = 1;
```

SELECT ë¬¸ìœ¼ë¡œ ëª¨ë“  ì»¬ëŸ¼ì„ ë‹¤ ê°–ê³  ì˜¤ëŠ” ê²ƒë³´ë‹¤, í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ê°€ì ¸ì™€ì„œ ì“°ëŠ”ê²Œ ë” ë‚«ë‹¤ê³  ìƒê°í•˜ì—¬ ê° Columnì˜ ì´ë¦„ì„ ì§€ì •í•˜ì—¬ ê°€ì ¸ ì˜¤ê²Œ í–ˆë‹¤.

ì´ë•Œ ì¸ìˆ˜ë¡œ í•„ìš”í•œ ê°’ì€ ì–´ë–¤ ì‚¬ìš©ìì˜ ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ì„ ê°€ì ¸ì˜¬ì§€, ì‚¬ìš©ìì˜ id ê°’ í•˜ë‚˜ë§Œì´ í•„ìš”í•˜ë‹¤.

ì´ì œ API ì½”ë“œë¡œ êµ¬í˜„ í•´ë³´ì

```js
/**
 * ì¥ë°”êµ¬ë‹ˆ ì „ì²´ì¡°íšŒ ë¡œì§ => ì‚¬ìš©ì í•œ ëª…ì— ëŒ€í•˜ì—¬
 * @param {import("express").Request} req
 * @param {import("express").Response} res
 * @param {import("express").NextFunction} next
 */
const getAllCartItems = (req, res, next) => {
  const { userId } = req.body;
  let sqlQuery = `
  SELECT cartitems.id AS cart_id, 
  books.price AS book_price, 
  cartitems.qty AS cart_qty, 
  cartItems.user_id AS user_id, 
  cartItems.book_id AS book_id   
  FROM cartitems LEFT 
  JOIN books ON books.id = cartitems.book_id
  WHERE cartitems.user_id = ?;
  `;
  let queryArg = [+userId];

  dbConnection.query(sqlQuery, queryArg, (err, results) => {
    if (err) {
      return res.status(StatusCodes.BAD_REQUEST).end();
    }
		if (results.length === 0) {
      return res.status(StatusCodes.NOT_FOUND).end();
    }
    return res.status(StatusCodes.OK).json(results);
  });
};
```

- Postman ìˆ˜í–‰ ê²°ê³¼

![ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒê²°ê³¼](../assets/img/post/2024/05/28/ì¥ë°”êµ¬ë‹ˆì¡°íšŒê²°ê³¼.png)

ì •ìƒì‘ë™ í•œë‹¤â€¦ ííí

ë§Œì•½ì— í•´ë‹¹ ì‚¬ìš©ìì˜ ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ 404ë¥¼ responseí•˜ë„ë¡ í•˜ì˜€ë‹¤.

### ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ ì‚­ì œ API

ì´ì œ ì¥ë°”êµ¬ë‹ˆì˜ ëª©ë¡ì„ ì‚­ì œí•˜ëŠ” ê³¼ì •ì´ í•„ìš”í•œë°.

ì¥ë°”êµ¬ë‹ˆì˜ ëª©ë¡ì„ ì•„ì˜ˆ ì‚­ì œí•˜ëŠ” ê±°ë‘, ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ì˜ ê°¯ìˆ˜ë¥¼ ì¤„ì´ëŠ” APIê°€ ë‘˜ë‹¤ í•„ìš”í•˜ì§€ ì•Šì„ ê¹Œ ìƒê°í•œë‹¤. ì¦‰, removeì™€ decrease ê¸°ëŠ¥ì´ ë“¤ì–´ìˆì–´ì•¼ í•œë‹¤.

decreaseë¡œ 0ê¹Œì§€ ë„ë‹¬í•˜ë©´, í•´ë‹¹ ìƒí’ˆì„ ì‚­ì œ í•˜ê³ , ê·¸ê²Œ ì•„ë‹ˆë©´ ê·¸ëƒ¥ ê°¯ìˆ˜ë§Œ ì¤„ì´ëŠ” ë°©ì‹ìœ¼ë¡œ ì§„í–‰í•˜ê³ , removeëŠ” í•œë²ˆì— í•´ë‹¹ ìƒí’ˆëª©ë¡ì„ ì§€ìš°ê³  ì‹¶ì„ ë•Œ í•„ìš”í•˜ê¸°ì— ë‘ ê¸°ëŠ¥ ì „ë¶€ ë§Œë“¤ê¸°ë¡œ í•œë‹¤.

### ì¥ë°”êµ¬ë‹ˆ ëª©ë¡ ê°¯ìˆ˜ ê°ì†Œ API

- ê°ì†Œ API ì½”ë“œ
    
    ```js
    /**
     * ì¹´íŠ¸ ì•„ì´í…œ ìˆ˜ëŸ‰ ê°ì†Œ
     * @param {import("express").Request} req
     * @param {import("express").Response} res
     */
    const decreaseCartItem = (req, res) => {
      const { userId, bookId } = req.body;
    
      let sqlQuery = `
      SELECT * FROM cartitems
      WHERE user_id=? AND book_id=?;  
      `;
    
      let queryArg = [+userId, +bookId];
    
      dbConnection.query(sqlQuery, queryArg, (err, result) => {
        if (err) {
          return res.status(StatusCodes.BAD_REQUEST).end();
        }
    
        const existItem = result[0];
        if (existItem) {
          //ì¹´íŠ¸ì— ì•„ì´í…œ ì¡´ì¬
          if (existItem.qty > 1) {
            // ìˆ˜ëŸ‰ ê°ì†Œ
            sqlQuery = `
            UPDATE cartitems
            SET qty = ?
            WHERE id = ?
            `;
            queryArg = [existItem.qty - 1, existItem.id];
    
            dbConnection.query(sqlQuery, queryArg, (err, result) => {
              if (err) {
                return res.status(StatusCodes.INTERNAL_SERVER_ERROR).end();
              }
    
              return res.status(StatusCodes.OK).json(result.affectedRows);
            });
          } else {
            sqlQuery = `
            DELETE FROM cartitems
            WHERE id=?
            `;
            queryArg = [existItem.id];
            dbConnection.query(sqlQuery, queryArg, (err, result) => {
              if (err) {
                return res.status(StatusCodes.INTERNAL_SERVER_ERROR).end();
              }
              return res.status(StatusCodes.OK).json(result);
            });
          }
        }
      });
    };
    ```
    
    - ì¹´íŠ¸ ì•„ì´í…œì˜ ìˆ˜ëŸ‰ì´ 1ê°œ ì´ˆê³¼ ì¼ ë•ŒëŠ”, í•´ë‹¹ ì•„ì´í…œì˜ ìˆ˜ëŸ‰ì„ 1 ê°ì†Œì‹œí‚¨ë‹¤.
    - ì¹´íŠ¸ ì•„ì´í…œì˜ ìˆ˜ëŸ‰ì¼ 1ì¼ ë•Œ í•´ë‹¹ APIê°€ ì‹¤í–‰ ë˜ë©´, í•´ë‹¹ ì¹´íŠ¸ ì•„ì´í…œì„ ì‚­ì œ í•˜ëŠ” ë¡œì§
    
    ### ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ì‚­ì œ API
    
    ```js
    
    /**
     * ì¥ë°”êµ¬ë‹ˆ ì•„ì´í…œ ì‚­ì œ ë¡œì§
     * @param {import("express").Request} req
     * @param {import("express").Response} res
     */
    const removeCartItem = (req, res) => {
      const { userId, bookId } = req.body;
    
      let sqlQuery = `
      DELETE FROM cartitems
      WHERE user_id=? AND book_id=?;
      `;
    
      let queryArg = [+userId, +bookId];
    
      dbConnection.query(sqlQuery, queryArg, (err, result) => {
        if (err) {
          return res.status(StatusCodes.BAD_REQUEST).end();
        }
    
        return res.status(StatusCodes.OK).json(result);
      });
    };
    ```
    
    í•´ë‹¹ APIëŠ” ê°„ë‹¨í•˜ê²Œ user_id ì™€ book_idë¥¼ í† ëŒ€ë¡œ, ì¼ì¹˜í•˜ëŠ” ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê¸°ë§Œ í•˜ëŠ” APIë¡œ ì‘ì„±í•˜ì˜€ë‹¤.
    

### cart.route.js

```js
const express = require("express");
const {
  addItemToCart,
  getAllCartItems,
  decreaseCartItem,
  removeCartItem,
} = require("../controller/cart.controller");
const router = express.Router();

router
  .route("/")
  .post(addItemToCart)
  .get(getAllCartItems)
  .delete(removeCartItem);
router.post("/decrease", decreaseCartItem);

module.exports = router;

```

- ìƒˆë¡œìš´ cart ê´€ë ¨ APIë¥¼ ì‘ì„±í•˜ë©´ì„œ, cart.route.jsì— ìœ„ì™€ ê°™ì€ routerë¥¼ ì„¤ì • í•´ì£¼ì—ˆë‹¤.